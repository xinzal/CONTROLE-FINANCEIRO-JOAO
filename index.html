<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle Financeiro - Meses e Viagem BGS</title>
<style>
  :root{--bg:#f4f6f9;--card:#fff;--accent:#2c3e50;--ok:#2ecc71;--danger:#e74c3c}
  body{font-family:Inter,Segoe UI,Arial; background:var(--bg); margin:0; padding:18px; color:#222}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto}
  h1{font-size:20px;margin:0;color:var(--accent)}
  .wrap{max-width:1200px;margin:14px auto}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input, select, button, textarea{padding:8px;border-radius:6px;border:1px solid #d0d4da;font-size:14px}
  button{cursor:pointer;background:var(--ok);color:#fff;border:none}
  button.ghost{background:transparent;border:1px solid #ccc;color:#333}
  button.danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  th{background:#f0f2f5}
  tr.pago{background:#eaf9ef;text-decoration:line-through;color:#444}
  .totals{display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap;margin-top:8px}
  .totbox{background:#fbfbfc;padding:10px;border-radius:8px;border:1px solid #eee;min-width:180px}
  nav.tabs{display:flex;gap:8px;margin-bottom:10px}
  nav.tabs button{background:#fff;border:1px solid #e6e9ee;padding:8px 12px;border-radius:8px;color:#333}
  nav.tabs button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  small.note{color:#666;display:block;margin-top:6px}
  .month-controls{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .bgs-list{max-height:180px;overflow:auto;padding:6px;border-radius:6px;border:1px dashed #eee;background:#fff}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
<header class="wrap">
  <h1>üí∞ Controle Financeiro ‚Äî Meses & Viagem BGS</h1>
  <div class="row">
    <div class="month-controls card" style="display:flex;gap:8px;align-items:center">
      <label class="muted">M√™s:</label>
      <select id="mesSelecionado"></select>
      <button onclick="novoMes()" title="Criar novo m√™s com base no atual">‚ûï Novo M√™s</button>
      <button class="ghost" onclick="exportarDados()">Exportar JSON</button>
    </div>
  </div>
</header>

<main class="wrap">
  <nav class="tabs card" role="tablist" aria-label="Abas">
    <button id="tabPrincipal" class="active" onclick="mostrarAba('principal')">Principal</button>
    <button id="tabViagem" onclick="mostrarAba('viagem')">Viagem BGS</button>
    <button id="tabHistorico" onclick="mostrarAba('historico')">Hist√≥rico M√™s</button>
    <button id="tabCasa" onclick="mostrarAba('casa')">Caixinha Casa</button>
    <button id="tabCofre" onclick="mostrarAba('cofre')">Cofre Jo√£o</button>
  </nav>

  <!-- PRINCIPAL -->
  <section id="aba-principal" class="card">
    <div class="row">
      <div style="flex:1;min-width:260px">
        <label><strong>Sal√°rio:</strong></label>
        <input id="salario" type="number" step="0.01" placeholder="R$ 0,00">
      </div>
      <div style="flex:1;min-width:260px">
        <label><strong>Renda Extra:</strong></label>
        <input id="rendaExtra" type="number" step="0.01" placeholder="R$ 0,00">
      </div>
      <div style="display:flex;align-items:end;">
        <button onclick="salvarEntradas()">Salvar Entradas</button>
      </div>
    </div>
    <small class="note">Saldo inicial = Sal√°rio + Renda Extra. Subtraia contas n√£o pagas e valores enviados para caixinhas. Depois 20% do que sobrou vai para Viagem BGS. O restante √© lazer.</small>

    <hr>

    <!-- adicionar item -->
    <div class="row" style="margin-top:6px">
      <input id="descricao" type="text" placeholder="Descri√ß√£o (ex: TIM, Academia)">
      <input id="valor" type="number" step="0.01" placeholder="Valor R$">
      <select id="tipo">
        <option value="fixo">Fixo</option>
        <option value="variavel">Vari√°vel</option>
        <option value="cartao">Cart√£o</option>
        <option value="viagem">Viagem</option>
        <option value="outro">Outro</option>
      </select>
      <input id="parcela" type="text" placeholder="Parcela (ex: 3/10) - opcional">
      <button onclick="adicionarItem()">Adicionar</button>
    </div>

    <!-- enviar para caixinhas -->
    <div class="row" style="margin-top:6px">
      <div style="flex:1;min-width:260px">
        <label><strong>Enviar para Caixinha Casa:</strong></label>
        <input id="valorCasa" type="number" step="0.01" placeholder="R$ 0,00">
      </div>
      <div style="flex:1;min-width:260px">
        <label><strong>Enviar para Cofre Jo√£o:</strong></label>
        <input id="valorCofre" type="number" step="0.01" placeholder="R$ 0,00">
      </div>
      <div style="display:flex;align-items:end;">
        <button onclick="enviarParaCaixinhas()">Enviar Valores</button>
      </div>
    </div>

    <!-- tabela de itens -->
    <table id="tabela">
      <thead>
        <tr><th>Descri√ß√£o</th><th>Valor (R$)</th><th>Tipo</th><th>Parcela</th><th>Pago?</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totals" id="totaisArea">
      <div class="totbox">
        <div class="muted">Saldo Total Inicial</div>
        <div id="saldoTotalInicial">R$ 0,00</div>
      </div>
      <div class="totbox">
        <div class="muted">Subtotal ap√≥s contas n√£o pagas</div>
        <div id="saldoDepoisContas">R$ 0,00</div>
      </div>
      <div class="totbox">
        <div class="muted">Enviado para Caixinha Casa</div>
        <div id="enviadoCasa">R$ 0,00</div>
      </div>
      <div class="totbox">
        <div class="muted">Enviado para Cofre Jo√£o</div>
        <div id="enviadoCofre">R$ 0,00</div>
      </div>
      <div class="totbox">
        <div class="muted">Saldo ap√≥s caixinhas</div>
        <div id="saldoDepoisCaixas">R$ 0,00</div>
      </div>
      <div class="totbox">
        <div class="muted">Valor reservado para Viagem BGS (20% do saldo restante)</div>
        <div id="valorBgsMes">R$ 0,00</div>
      </div>
      <div class="totbox">
        <div class="muted">Valor dispon√≠vel para lazer</div>
        <div id="valorLazer">R$ 0,00</div>
      </div>
    </div>
  </section>

  <!-- VIAGEM BGS -->
  <section id="aba-viagem" class="card" style="display:none">
    <h3>Viagem BGS ‚Äî Acumulado</h3>
    <p class="muted">Total acumulado da Viagem BGS (20% do saldo ap√≥s caixinhas a cada m√™s).</p>
    <div style="display:flex;gap:16px;align-items:center">
      <div style="flex:1">
        <div class="muted">Total acumulado:</div>
        <h2 id="bgsTotal">R$ 0,00</h2>
      </div>
      <div style="flex:1">
        <div class="muted">Contribui√ß√µes por m√™s:</div>
        <div class="bgs-list" id="bgsContribList"></div>
      </div>
    </div>
  </section>

  <!-- CAIXA UI -->
  <section id="aba-casa" class="card" style="display:none">
    <h3>Caixinha Casa ‚Äî Acumulado</h3>
    <div style="display:flex;gap:16px;align-items:center">
      <div style="flex:1">
        <div class="muted">Total acumulado:</div>
        <h2 id="casaTotal">R$ 0,00</h2>
      </div>
      <div style="flex:1">
        <div class="muted">Valores enviados por m√™s:</div>
        <div class="bgs-list" id="casaContribList"></div>
      </div>
    </div>
  </section>

  <!-- COFRE UI -->
  <section id="aba-cofre" class="card" style="display:none">
    <h3>Cofre Jo√£o ‚Äî Acumulado</h3>
    <div style="display:flex;gap:16px;align-items:center">
      <div style="flex:1">
        <div class="muted">Total acumulado:</div>
        <h2 id="cofreTotal">R$ 0,00</h2>
      </div>
      <div style="flex:1">
        <div class="muted">Valores enviados por m√™s:</div>
        <div class="bgs-list" id="cofreContribList"></div>
      </div>
    </div>
  </section>

  <!-- HIST√ìRICO -->
  <section id="aba-historico" class="card" style="display:none">
    <h3>Hist√≥rico de Meses</h3>
    <div id="historicoList"></div>
  </section>

</main>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyHlRe0jhvBlcfIdDKa8FBM9Ufr7TH0MUzkzn9BvONQyMRYQ1Myn1AxC-ykroy1Uz2x/exec";

let meses = [];
let mesAtual = null;
let dadosMes = {};
let itens = [];

function mostrarAba(aba){
  document.querySelectorAll('section[id^="aba-"]').forEach(sec => sec.style.display="none");
  document.getElementById("aba-"+aba).style.display="block";
  document.querySelectorAll("nav.tabs button").forEach(btn => btn.classList.remove("active"));
  document.getElementById("tab"+aba.charAt(0).toUpperCase()+aba.slice(1)).classList.add("active");
}

// FORMATA√á√ÉO REAL
function formatarReal(valor){return Number(valor).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}

// SALVAR ENTRADAS
function salvarEntradas(){
  if(!mesAtual){alert("Selecione ou crie um m√™s!");return;}
  dadosMes.salario = parseFloat(document.getElementById("salario").value)||0;
  dadosMes.rendaExtra = parseFloat(document.getElementById("rendaExtra").value)||0;
  atualizarTotais();
  salvarWebApp();
}

// ADICIONAR ITEM
function adicionarItem(){
  const descricao = document.getElementById("descricao").value;
  const valor = parseFloat(document.getElementById("valor").value)||0;
  const tipo = document.getElementById("tipo").value;
  const parcela = document.getElementById("parcela").value;
  if(!descricao){alert("Informe a descri√ß√£o do item!");return;}
  itens.push({descricao,valor,tipo,parcela,pago:false});
  document.getElementById("descricao").value="";
  document.getElementById("valor").value="";
  document.getElementById("parcela").value="";
  renderTabela();
  atualizarTotais();
}

// MARCAR COMO PAGO
function togglePago(idx){itens[idx].pago=!itens[idx].pago;renderTabela();atualizarTotais();}

// ENVIAR PARA CAIXINHAS
function enviarParaCaixinhas(){
  dadosMes.casa = parseFloat(document.getElementById("valorCasa").value)||0;
  dadosMes.cofre = parseFloat(document.getElementById("valorCofre").value)||0;
  document.getElementById("valorCasa").value="";
  document.getElementById("valorCofre").value="";
  atualizarTotais();
  salvarWebApp();
}

// NOVO M√äS
function novoMes(){
  const nome = prompt("Nome do novo m√™s:");
  if(!nome) return;
  mesAtual = nome;
  meses.push(nome);
  mesSelecionado.options.add(new Option(nome,nome));
  mesSelecionado.value = nome;
  dadosMes = {salario:0,rendaExtra:0,casa:0,cofre:0,itens:[]};
  itens = [];
  renderTabela();
  atualizarTotais();
}

// RENDER TABELA
function renderTabela(){
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML="";
  itens.forEach((item,idx)=>{
    const tr=document.createElement("tr");
    if(item.pago) tr.classList.add("pago");
    tr.innerHTML=`<td>${item.descricao}</td>
    <td>${formatarReal(item.valor)}</td>
    <td>${item.tipo}</td>
    <td>${item.parcela||''}</td>
    <td><input type="checkbox" onclick="togglePago(${idx})" ${item.pago?'checked':''}></td>
    <td><button class="danger" onclick="itens.splice(${idx},1);renderTabela();atualizarTotais();">‚ùå</button></td>`;
    tbody.appendChild(tr);
  });
}

// ATUALIZAR TOTAIS
function atualizarTotais(){
  const saldoTotal = (dadosMes.salario||0)+(dadosMes.rendaExtra||0);
  const contasNaoPagas = itens.filter(i=>!i.pago).reduce((a,b)=>a+b.valor,0);
  const enviadoCasa = dadosMes.casa||0;
  const enviadoCofre = dadosMes.cofre||0;
  const saldoDepoisCaixas = saldoTotal - contasNaoPagas - enviadoCasa - enviadoCofre;
  const valorBgs = saldoDepoisCaixas*0.2;
  const valorLazer = saldoDepoisCaixas-valorBgs;

  document.getElementById("saldoTotalInicial").innerText=formatarReal(saldoTotal);
  document.getElementById("saldoDepoisContas").innerText=formatarReal(saldoTotal-contasNaoPagas);
  document.getElementById("enviadoCasa").innerText=formatarReal(enviadoCasa);
  document.getElementById("enviadoCofre").innerText=formatarReal(enviadoCofre);
  document.getElementById("saldoDepoisCaixas").innerText=formatarReal(saldoDepoisCaixas);
  document.getElementById("valorBgsMes").innerText=formatarReal(valorBgs);
  document.getElementById("valorLazer").innerText=formatarReal(valorLazer);

  // Atualiza abas de acumulo
  document.getElementById("bgsTotal").innerText=formatarReal(valorBgs);
  document.getElementById("casaTotal").innerText=formatarReal(enviadoCasa);
  document.getElementById("cofreTotal").innerText=formatarReal(enviadoCofre);

  document.getElementById("bgsContribList").innerHTML=formatarReal(valorBgs);
  document.getElementById("casaContribList").innerHTML=formatarReal(enviadoCasa);
  document.getElementById("cofreContribList").innerHTML=formatarReal(enviadoCofre);
}

// SALVAR NO WEBAPP
function salvarWebApp(){
  if(!mesAtual) return;
  const payload = {
    mes: mesAtual,
    salario: dadosMes.salario||0,
    rendaExtra: dadosMes.rendaExtra||0,
    casa: dadosMes.casa||0,
    cofre: dadosMes.cofre||0,
    itens: itens
  };
  fetch(WEBAPP_URL,{
    method:"POST",
    body: JSON.stringify(payload),
    headers: {"Content-Type":"application/json"}
  }).then(res=>res.json())
    .then(resp=>{console.log("Dados salvos:",resp);})
    .catch(err=>console.error("Erro ao salvar:",err));
}

// EXPORTAR JSON
function exportarDados(){ 
  const exportObj = {mes:mesAtual, ...dadosMes, itens};
  const blob = new Blob([JSON.stringify(exportObj,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");a.href=url;a.download=`Mes_${mesAtual}.json`;a.click();
}

// SELECT MES
const mesSelecionado = document.getElementById("mesSelecionado");
</script>
</body>
</html>
